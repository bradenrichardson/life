AWSTemplateFormatVersion: "2010-09-09"
Description: Deploys the infrastructure for Life Dashboard

Parameters:
  GatewayName:
    Type: String
    Default: WebhookGateway

  GatewayStageName:
    Type: String
    Default: dev

  GatewayHTTPMethod:
    Type: String
    Default: POST

  DBInstanceID:
    Type: String
    Default: lifedbinstance

  DBName:
    Type: String
    Default: lifedb

  DBInstanceClass:
    Type: String
    Default: db.t2.micro

  DBAllocatedStorage:
    Type: Number
    Default: '20'

  DBUsername:
    NoEcho: 'true'
    Type: String
    Default: admin

  DBPassword:
    NoEcho: 'true'
    Type: String
    Default: password
  

Resources:

## IAM
  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Policies:
      - PolicyName: lambda
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            - ec2:DescribeNetworkInterfaces
            - ec2:CreateNetworkInterface
            - ec2:DeleteNetworkInterface
            - ec2:DescribeInstances
            - ec2:AttachNetworkInterface
            - s3:*
            - codepipeline:PutJobSuccessResult
            - codepipeline:PutJobFailureResult
            Effect: Allow
            Resource:
              - '*' 

  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - codepipeline.amazonaws.com
          Action:
          - sts:AssumeRole
      Policies:
      - PolicyName: codepipeline
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Action:
            - lambda:*
            - cloudwatch:*
            - rds:*
            - sqs:*
            - ec2:*
            - s3:*
            - codebuild:*
            Effect: Allow
            Resource:
              - '*'

## LOG GROUP
  WebhookLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/webhookfunction
      RetentionInDays: 90
  
  RequestLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/requestfunction
      RetentionInDays: 90

## LAMBDA
  WebhookApiGatewayInvoke:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt WebhookLambdaFunction.Arn
      Principal: apigateway.amazonaws.com

  WebhookLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        ZipFile: |
          def handler(event,context):
            return {
              'body': 'Hello there {0}'.format(event['requestContext']['identity']['sourceIp']),
              'headers': {
                'Content-Type': 'text/plain'
              },
              'statusCode': 200
            }
      Description: Receives POST request via webhook
      FunctionName: WebhookLambda
      Handler: index.handler
      Role: !GetAtt LambdaRole.Arn
      Runtime: python3.7
      VpcConfig:
        SecurityGroupIds: [!Ref LambdaSecurityGroup]
        SubnetIds: [!Ref PrivateSubnetA, !Ref PrivateSubnetB] 
  
  InitialiseDatabase:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        ZipFile: |
          import json
          import os
          import pymysql
          import sys
          import boto3
          import yaml
          endpoint  = os.environ.get('endpoint')
          username = os.environ.get('username')
          password = os.environ.get('password')
          database_name = os.environ.get('database_name')


          def get_object(bucket, key):
              s3 = boto3.resource('s3')
              obj = s3.Object(bucket, key)
              
              config = obj.get()['Body'].read()
              yamlConfig = yaml.safe_load(config)
              
              return yamlConfig

          def initialise_database(config):
              dataSources = config.get('DataSources').keys()
              
              for datasource in dataSources:
                  executionString = 'CREATE TABLE {}'.format(datasource)
                  for key in config.get(datasource):
                      print(key)
              
              
              # return config
              # try:
              #     connection = pymysql.connect(host=endpoint, user=username, passwd=password, db=database_name)
              # except pymysql.MySQLError as e:
              #     print(e)
              # print('establishing database connection')
              # with connection.cursor() as cursor:
              #     cursor.execute(executionString)
              #     connection.commit()
                  
          def handler(event, context):
              print(event)
              
              pipeline = boto3.client('codepipeline')
              response = pipeline.put_job_success_result(
                jobId=event['CodePipeline.job']['id']
              )
              
              inputArtifacts = event.get('CodePipeline.job').get('data').get('inputArtifacts')
              bucketName = inputArtifacts[0]['location'].get('s3Location').get('bucketName')
              objectKey = inputArtifacts[0]['location'].get('s3Location').get('objectKey')
              
              initialise_database(get_object(bucketName, objectKey))
              # return response 
      Description: Creates and initialises tables within MySql database
      Environment:
        Variables:
          endpoint : !GetAtt LifeDatabase.Endpoint.Address
          username : !Ref DBUsername
          password : !Ref DBPassword
          database_name : !Ref DBName
      FunctionName: InitialiseDatabaseLambda
      Handler: index.handler
      Role: !GetAtt LambdaRole.Arn
      Runtime: python3.7
      Layers: [arn:aws:lambda:ap-southeast-2:007576465237:layer:pymysql:3, arn:aws:lambda:ap-southeast-2:007576465237:layer:pyaml:1]
      VpcConfig:
        SecurityGroupIds: [!Ref LambdaSecurityGroup]
        SubnetIds: [!Ref PrivateSubnetA, !Ref PrivateSubnetB]
  
  UpdateDatabase:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        ZipFile: |
          def handler(event,context):
            return {
              'body': 'Hello there {0}'.format(event['requestContext']['identity']['sourceIp']),
              'headers': {
                'Content-Type': 'text/plain'
              },
              'statusCode': 200
            }
      Description: Updates MySql database 
      Environment:
        Variables:
          endpoint : !GetAtt LifeDatabase.Endpoint.Address
          username : !Ref DBUsername
          password : !Ref DBPassword
          database_name : !Ref DBName
      FunctionName: UpdateDatabaseLambda
      Handler: index.handler
      Role: !GetAtt LambdaRole.Arn
      Runtime: python3.7
      Layers: [arn:aws:lambda:ap-southeast-2:007576465237:layer:pymysql:1]
      VpcConfig:
        SecurityGroupIds: [!Ref LambdaSecurityGroup]
        SubnetIds: [!Ref PrivateSubnetA, !Ref PrivateSubnetB]

  RequestLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        ZipFile: |
          def handler(event,context):
            return {
              'body': 'Hello there {0}'.format(event['requestContext']['identity']['sourceIp']),
              'headers': {
                'Content-Type': 'text/plain'
              },
              'statusCode': 200
            }
      Description: Makes a GET call to a public API
      FunctionName: RequestLambda
      Handler: index.handler
      Role: !GetAtt LambdaRole.Arn
      Runtime: python3.7
      Layers: [arn:aws:lambda:ap-southeast-2:007576465237:layer:requests-python-layer:1]
      VpcConfig:
        SecurityGroupIds: [!Ref LambdaSecurityGroup]
        SubnetIds: [!Ref PrivateSubnetA, !Ref PrivateSubnetB]
  
  


## API GATEWAY
  WebhookGateway:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Ref GatewayName
      EndpointConfiguration:
        Types:
          - REGIONAL
      Description: Gateway to process webhook requests

  WebhookGatewayGetMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      HttpMethod: !Ref GatewayHTTPMethod
      Integration:
        IntegrationHttpMethod: GET
        Type: AWS_PROXY
        Uri: !Sub
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebhookLambdaArn}/invocations
          - WebhookLambdaArn: !GetAtt WebhookLambdaFunction.Arn
      ResourceId: !GetAtt WebhookGateway.RootResourceId
      RestApiId: !Ref WebhookGateway

  WebhookGatewayDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - WebhookGatewayGetMethod
    Properties:
      RestApiId: !Ref WebhookGateway
      StageName: !Ref GatewayStageName

## NETWORKING
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    DependsOn: LifeDashboardVPC
  
  LifeDashboardVPC:
    Type: AWS::EC2::VPC
    Properties:
      EnableDnsSupport: true
      EnableDnsHostnames: true
      CidrBlock: 10.1.0.0/16
      Tags:
      - Key: Name
        Value: !Join ['', [!Ref "AWS::StackName", "-VPC" ]]
  
  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref LifeDashboardVPC
  
  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 10.1.50.0/24
      VpcId: !Ref LifeDashboardVPC
      AvailabilityZone: !Select [ 0, !GetAZs ]
      Tags:
      - Key: Name
        Value: !Sub ${AWS::StackName}-PrivateA
  
  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 10.1.60.0/24
      VpcId: !Ref LifeDashboardVPC
      AvailabilityZone: !Select [ 1, !GetAZs ]
      Tags:
      - Key: Name
        Value: !Sub ${AWS::StackName}-PrivateB
  
  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 10.1.10.0/24
      VpcId: !Ref LifeDashboardVPC
      AvailabilityZone: !Select [ 0, !GetAZs ]
      Tags:
      - Key: Name
        Value: !Sub ${AWS::StackName}-PublicA
  
  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 10.1.20.0/24
      VpcId: !Ref LifeDashboardVPC
      AvailabilityZone: !Select [ 1, !GetAZs ]
      Tags:
      - Key: Name
        Value: !Sub ${AWS::StackName}-PublicB
  
  EIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: LifeDashboardVPC
  
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref LifeDashboardVPC
      Tags:
      - Key: Name
        Value: Public
  
  PublicRoute1:
    Type: AWS::EC2::Route
    DependsOn:
      - InternetGateway
      - VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
  
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref LifeDashboardVPC
      Tags:
      - Key: Name
        Value: Private
  
  PrivateRoute1:
    Type: AWS::EC2::Route
    DependsOn: PrivateRouteTable
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt EIP.AllocationId
      SubnetId: !Ref PublicSubnetA
      Tags:
      - Key: Name
        Value: !Sub NAT-${AWS::StackName}
  
  PublicSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable
  
  PublicSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref PublicRouteTable
  
  PrivateSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    DependsOn: PrivateRouteTable
    Properties:
      SubnetId: !Ref PrivateSubnetA
      RouteTableId: !Ref PrivateRouteTable
  
  PrivateSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetB
      RouteTableId: !Ref PrivateRouteTable
  
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref LifeDashboardVPC
      GroupDescription: Ingress/Egress rules for the lambdas
      SecurityGroupIngress:
      - IpProtocol: -1
        CidrIp: 0.0.0.0/0
        ToPort: -1
        FromPort: -1
      SecurityGroupEgress:
      - IpProtocol: -1
        CidrIp: 0.0.0.0/0
        ToPort: -1
        FromPort: -1
  
  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref LifeDashboardVPC
      GroupDescription: Ingress/Egress rules for the mysql instance
      SecurityGroupIngress:
      - IpProtocol: -1
        CidrIp: 0.0.0.0/0
        ToPort: -1
        FromPort: -1
      SecurityGroupEgress:
      - IpProtocol: -1
        CidrIp: 0.0.0.0/0
        ToPort: -1
        FromPort: -1

  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      SubnetIds:
        - !Ref PrivateSubnetA
        - !Ref PrivateSubnetB
      DBSubnetGroupDescription: Subnet group for MySQL instance

## DATABASE
  LifeDatabase:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Ref DBInstanceID
      DBName: !Ref DBName
      DBInstanceClass: !Ref DBInstanceClass
      AllocatedStorage: !Ref DBAllocatedStorage
      Engine: MySQL
      EngineVersion: 8.0.16
      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Ref DBPassword
      DBSubnetGroupName: !Ref DBSubnetGroup
      VPCSecurityGroups: [ !GetAtt  DatabaseSecurityGroup.GroupId ]

## CODEPIPELINE
  ConfigurationSourceBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: configuration-source-bucket
      VersioningConfiguration:
        Status: Enabled
  
  S3CRUD:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        ZipFile: |
          import yaml, boto3, logging
          import os
          import cfnresponse
          logger = logging.getLogger()
          logger.setLevel(logging.DEBUG)

          configurationBucket = os.environ.get('ConfigurationBucket')
          pipelineBucket = os.environ.get('PipelineBucket')

          s3template = {
            "key" : "value"
          }

          def handler(event, context):
            logger.info("event: {}".format(event))
            try:
                logger.info("configurationBucket: {}, event['RequestType']: {}".format(configurationBucket,event['RequestType']))
                
                if event['RequestType'] == 'Create':
                  logger.info('Created!')
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                  client = boto3.client('s3')
                  response = client.put_object(
                      Bucket=configurationBucket,
                      Body=yaml.dump(s3template),
                      Key="config.yml"
                  )

                if event['RequestType'] == 'Delete':
                  logger.info('Deleted!')
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                  
                  s3 = boto3.resource('s3')

                  configBucket = s3.Bucket(configurationBucket)
                  pipeBucket = s3.Bucket(pipelineBucket)
                  
                  configBucket.object_versions.all().delete()
                  pipelineBucket.object_versions.all().delete()
                  pipeBucket.objects.all().delete()
              
            except Exception as e:
              logger.info("Exception: {}".format(e))
              cfnresponse.send(event, context, cfnresponse.FAILED, {})
      Description: Creates a template file in an s3 bucket
      Environment:
        Variables:
          ConfigurationBucket : !Ref ConfigurationSourceBucket
          PipelineBucket: !Ref PipelineArtifactStore
      FunctionName: S3CRUD
      Handler: index.handler
      Role: !GetAtt LambdaRole.Arn
      Runtime: python3.7
      Layers: [arn:aws:lambda:ap-southeast-2:007576465237:layer:cfnresponse:1, arn:aws:lambda:ap-southeast-2:007576465237:layer:pyaml:1]
      VpcConfig:
        SecurityGroupIds: [!Ref LambdaSecurityGroup]
        SubnetIds: [!Ref PrivateSubnetA, !Ref PrivateSubnetB]
  
  CustomS3CRUD:
    Type: Custom::CustomResource
    DependsOn: 
    - S3CRUD
    - NATGateway
    - LifeDashboardVPC
    - PublicRoute1
    - PrivateRoute1
    - VPCGatewayAttachment
    - PublicSubnetA
    - PublicSubnetB
    - PrivateSubnetA
    - PrivateSubnetB
    - InternetGateway
    - PublicRouteTable
    - PrivateRouteTable
    - PublicSubnetARouteTableAssociation
    - PublicSubnetBRouteTableAssociation
    - PrivateSubnetARouteTableAssociation
    - PrivateSubnetBRouteTableAssociation
    Properties:
      ServiceToken: !GetAtt S3CRUD.Arn

  PipelineArtifactStore:
    Type: AWS::S3::Bucket
  
  ConfigurationPipeline:
    Type: AWS::CodePipeline::Pipeline
    # DependsOn: CustomS3Object
    Properties:
      ArtifactStore: 
        Location: !Ref PipelineArtifactStore
        Type: S3
      Name: configuration-pipeline
      RoleArn: !GetAtt CodePipelineRole.Arn
      Stages:
 
        # Stage 1: Get the source configuration file from S3 bucket
        - Name: Source
          Actions:
            - Name: SourceAction
              RunOrder: 1
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: S3
                Version: 1
              Configuration:
                S3Bucket: !Ref ConfigurationSourceBucket
                S3ObjectKey: "config.yml"
              OutputArtifacts:
                - Name: SourceCode
        
        # Stage 2: Initialise database with configuration details from S3 bucket
        - Name: InitialiseDatabase
          Actions:
            - Name: InitialiseDatabaseAction
              RunOrder: 2
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Provider: Lambda
                Version: '1'
              Configuration:
                FunctionName: InitialiseDatabaseLambda
              OutputArtifacts: []
              InputArtifacts:
                - Name: SourceCode
              Region: ap-southeast-2
        


  
                



Outputs:
  WebhookGatewayInvokeURL:
    Value: !Sub https://${WebhookGateway}.execute-api.${AWS::Region}.amazonaws.com/${GatewayStageName}
  
  WebhookLambdaArn:
    Value: !GetAtt WebhookLambdaFunction.Arn
    